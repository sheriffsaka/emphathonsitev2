-- Enable the necessary extensions
create extension if not exists "uuid-ossp";

-- 1. CARS TABLE
create table public.cars (
  id uuid default uuid_generate_v4() primary key,
  brand text not null,
  model text not null,
  year integer not null,
  price numeric not null,
  mileage integer not null,
  transmission text check (transmission in ('Automatic', 'Manual', 'PDK', 'E-Drive')),
  fuel_type text check (fuel_type in ('Petrol', 'Hybrid', 'Electric', 'Diesel')),
  status text check (status in ('Available', 'Reserved', 'Pre-Order')),
  condition text check (condition in ('New', 'Used', 'Certified Pre-Owned')), -- Added for filtering
  buyer_type text[] not null,
  image_url text not null,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 2. PREORDERS TABLE
create table public.preorders (
  id uuid default uuid_generate_v4() primary key,
  full_name text not null,
  email text not null,
  phone text,
  brand text,
  model text,
  color text,
  expected_delivery date,
  notes text,
  buyer_type text,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 3. APPOINTMENTS TABLE
create table public.appointments (
  id uuid default uuid_generate_v4() primary key,
  full_name text not null,
  email text not null,
  phone text,
  appointment_date date,
  message text,
  visit_type text,
  buyer_type text,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 4. HERO_MEDIA TABLE
create table public.hero_media (
  id uuid default uuid_generate_v4() primary key,
  title text not null,
  subtitle text,
  image_url text not null,
  cta_primary_text text,
  cta_primary_link text,
  cta_secondary_text text,
  cta_secondary_link text,
  display_order integer default 0,
  is_active boolean default true,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 5. TESTIMONIALS TABLE
create table public.testimonials (
  id uuid default uuid_generate_v4() primary key,
  client_name text not null,
  role text,
  client_type text check (client_type in ('Corporate', 'Individual')),
  content text not null,
  rating integer check (rating >= 1 and rating <= 5),
  avatar_url text,
  car_purchased_image_url text,
  is_verified boolean default true,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 6. INQUIRIES TABLE (General Contact)
create table public.inquiries (
  id uuid default uuid_generate_v4() primary key,
  name text not null,
  email text not null,
  subject text,
  message text not null,
  status text default 'New', -- New, Read, Replied
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 7. CORPORATE_REQUESTS TABLE (Specific Bulk Fleet Requests)
create table public.corporate_requests (
  id uuid default uuid_generate_v4() primary key,
  company_name text not null,
  contact_person text not null,
  email text not null,
  fleet_size_interest integer,
  requested_models text[],
  status text default 'Pending',
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- ENABLE ROW LEVEL SECURITY
alter table public.cars enable row level security;
alter table public.preorders enable row level security;
alter table public.appointments enable row level security;
alter table public.hero_media enable row level security;
alter table public.testimonials enable row level security;
alter table public.inquiries enable row level security;
alter table public.corporate_requests enable row level security;

-- GENERIC PUBLIC READ POLICIES
create policy "Public read cars" on public.cars for select to anon using (true);
create policy "Public read hero" on public.hero_media for select to anon using (true);
create policy "Public read testimonials" on public.testimonials for select to anon using (true);

-- GENERIC PUBLIC INSERT POLICIES
create policy "Public insert preorders" on public.preorders for insert to anon with check (true);
create policy "Public insert appointments" on public.appointments for insert to anon with check (true);
create policy "Public insert inquiries" on public.inquiries for insert to anon with check (true);
create policy "Public insert corporate" on public.corporate_requests for insert to anon with check (true);

-- SEED DATA (Updated)
insert into public.cars (brand, model, year, price, mileage, transmission, fuel_type, status, condition, buyer_type, image_url)
values
  ('Rolls-Royce', 'Phantom Extended', 2024, 650000, 450, 'Automatic', 'Petrol', 'Available', 'Certified Pre-Owned', ARRAY['Corporate', 'Individual'], 'https://images.unsplash.com/photo-1631295868223-63260951bcb7?auto=format&fit=crop&q=80&w=800'),
  ('Bentley', 'Continental GT Speed', 2024, 340000, 1200, 'Automatic', 'Petrol', 'Pre-Order', 'New', ARRAY['Individual'], 'https://images.unsplash.com/photo-1621135802920-133df287f89c?auto=format&fit=crop&q=80&w=800');
