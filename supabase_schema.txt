
-- Enable the necessary extensions
create extension if not exists "uuid-ossp";

-- ==========================================
-- 1. TABLES SETUP
-- ==========================================

-- CARS TABLE
create table if not exists public.cars (
  id uuid default uuid_generate_v4() primary key,
  brand text not null,
  model text not null,
  year integer not null,
  price numeric not null,
  mileage integer not null,
  transmission text check (transmission in ('Automatic', 'Manual', 'PDK', 'E-Drive')),
  fuel_type text check (fuel_type in ('Petrol', 'Hybrid', 'Electric', 'Diesel')),
  status text check (status in ('Available', 'Reserved', 'Pre-Order')),
  condition text check (condition in ('New', 'Used', 'Certified Pre-Owned')), 
  buyer_type text[] not null,
  image_url text not null,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- PREORDERS TABLE
create table if not exists public.preorders (
  id uuid default uuid_generate_v4() primary key,
  full_name text not null,
  email text not null,
  phone text,
  brand text,
  model text,
  color text,
  expected_delivery date,
  notes text,
  buyer_type text,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- APPOINTMENTS TABLE
create table if not exists public.appointments (
  id uuid default uuid_generate_v4() primary key,
  full_name text not null,
  email text not null,
  phone text,
  appointment_date date,
  message text,
  visit_type text,
  buyer_type text,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- HERO_MEDIA TABLE
create table if not exists public.hero_media (
  id uuid default uuid_generate_v4() primary key,
  title text not null,
  subtitle text,
  image_url text not null,
  cta_primary_text text,
  cta_primary_link text,
  cta_secondary_text text,
  cta_secondary_link text,
  display_order integer default 0,
  is_active boolean default true,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- TESTIMONIALS TABLE
create table if not exists public.testimonials (
  id uuid default uuid_generate_v4() primary key,
  client_name text not null,
  role text,
  client_type text check (client_type in ('Corporate', 'Individual')),
  content text not null,
  rating integer check (rating >= 1 and rating <= 5),
  avatar_url text,
  car_purchased_image_url text,
  is_verified boolean default true,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- INQUIRIES TABLE
create table if not exists public.inquiries (
  id uuid default uuid_generate_v4() primary key,
  name text not null,
  email text not null,
  subject text,
  message text not null,
  status text default 'New', 
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- CORPORATE_REQUESTS TABLE
create table if not exists public.corporate_requests (
  id uuid default uuid_generate_v4() primary key,
  company_name text not null,
  contact_person text not null,
  email text not null,
  fleet_size_interest integer,
  requested_models text[],
  status text default 'Pending',
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- ==========================================
-- 2. SECURITY (RLS) POLICIES
-- ==========================================

-- Enable RLS on all tables
alter table public.cars enable row level security;
alter table public.preorders enable row level security;
alter table public.appointments enable row level security;
alter table public.hero_media enable row level security;
alter table public.testimonials enable row level security;
alter table public.inquiries enable row level security;
alter table public.corporate_requests enable row level security;

-- Drop existing policies to prevent conflicts if re-running
drop policy if exists "Public read cars" on public.cars;
drop policy if exists "Public insert cars" on public.cars;
drop policy if exists "Public update cars" on public.cars;
drop policy if exists "Public delete cars" on public.cars;

drop policy if exists "Public read hero" on public.hero_media;
drop policy if exists "Public insert hero" on public.hero_media;
drop policy if exists "Public update hero" on public.hero_media;
drop policy if exists "Public delete hero" on public.hero_media;

drop policy if exists "Public read testimonials" on public.testimonials;
drop policy if exists "Public insert testimonials" on public.testimonials;
drop policy if exists "Public update testimonials" on public.testimonials;
drop policy if exists "Public delete testimonials" on public.testimonials;

-- READ POLICIES (Public can view content)
create policy "Public read cars" on public.cars for select to anon using (true);
create policy "Public read hero" on public.hero_media for select to anon using (true);
create policy "Public read testimonials" on public.testimonials for select to anon using (true);

-- WRITE POLICIES (Allow Admin/Anon to edit content for this demo)
-- Note: In a real app, 'to anon' should be replaced with 'to authenticated' and check admin roles.

-- Cars
create policy "Public insert cars" on public.cars for insert to anon with check (true);
create policy "Public update cars" on public.cars for update to anon using (true);
create policy "Public delete cars" on public.cars for delete to anon using (true);

-- Hero
create policy "Public insert hero" on public.hero_media for insert to anon with check (true);
create policy "Public update hero" on public.hero_media for update to anon using (true);
create policy "Public delete hero" on public.hero_media for delete to anon using (true);

-- Testimonials
create policy "Public insert testimonials" on public.testimonials for insert to anon with check (true);
create policy "Public update testimonials" on public.testimonials for update to anon using (true);
create policy "Public delete testimonials" on public.testimonials for delete to anon using (true);

-- CRM Data (Insert Only for Public, Read for Admin would need Auth, here we allow all for demo)
create policy "Public insert preorders" on public.preorders for insert to anon with check (true);
create policy "Admin read preorders" on public.preorders for select to anon using (true); -- Demo mode: allows fetching on CRM page

create policy "Public insert appointments" on public.appointments for insert to anon with check (true);
create policy "Admin read appointments" on public.appointments for select to anon using (true);

create policy "Public insert inquiries" on public.inquiries for insert to anon with check (true);
create policy "Admin read inquiries" on public.inquiries for select to anon using (true);

create policy "Public insert corporate" on public.corporate_requests for insert to anon with check (true);
create policy "Admin read corporate" on public.corporate_requests for select to anon using (true);


-- ==========================================
-- 3. STORAGE BUCKET SETUP
-- ==========================================
insert into storage.buckets (id, name, public)
values ('media', 'media', true)
on conflict (id) do nothing;

-- Storage Policies
drop policy if exists "Public Access" on storage.objects;
drop policy if exists "Public Upload" on storage.objects;
drop policy if exists "Public Update" on storage.objects;

create policy "Public Access"
  on storage.objects for select
  using ( bucket_id = 'media' );

create policy "Public Upload"
  on storage.objects for insert
  to anon
  with check ( bucket_id = 'media' );

create policy "Public Update"
  on storage.objects for update
  to anon
  using ( bucket_id = 'media' );
